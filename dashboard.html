<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="utf-8">
      <title>Realtime Healthcare Dashboard</title>
      <!-- Loading Bootstrap -->
      <link href="bootstrap/css/bootstrap.css" rel="stylesheet">
      <!-- Loading Font Awesome Icons -->
      <link href="css/font-awesome.min.css" rel="stylesheet">
      <!-- Loading Drunken Parrot UI -->
      <link href="css/drunken-parrot.css" rel="stylesheet">
      <link href="css/demo.css" rel="stylesheet">
      <!-- Loading Wearable UI -->
      <link href="css/wearable.css" rel="stylesheet">
      <link id="data-uikit-theme" rel="stylesheet" href="uikit/css/uikit.css">
      <link rel="stylesheet" href="css/jquery-ui.css">
      <style>
         #batteryGauge {
         width:93px; height:73px;
         display: inline-block;
         margin: 0em;
         }
         #DEBUGPANEL {
         height: 610px;
         }
         .en { display:none; }
         .es { display:none; }
      </style>
      <script language="javascript" type="text/javascript">
         var version = "v2.2.0";
         var serverURI = "oraclewearable.ddns.net:8080";
         var wsserverURI = "oraclewearable.ddns.net:8080";

         function enableLanguage(lan) {
           for (var i = 0; i < document.styleSheets.length; i++) {
             if (document.styleSheets[i].cssRules) {
               var rules = document.styleSheets[i].cssRules;
               for (var r = 0; r < rules.length; r++) {
                 if (rules[r].selectorText == "." + lan.toLowerCase()) {
                   rules[r].style.display = 'block';
                 }
               }
             }
           }
         }
      </script>

   </head>
   <body onload="setInterval('updateClock()', 1000);">
      <div class="container">
         <div class="row">
            <div class="col-md-12">
               <div id="panels">
                  <p>
                     <!-- BEGIN row  TITLE, CLOCK -->
                  <div class="row center-cell">
                     <div class="col-md-3" align=left>

                       <div class="uk-button-dropdown" data-uk-dropdown="{mode:'click'}">
                           <button id="selectDevice" class="uk-button">SmartWatch&nbsp;&nbsp;&nbsp;<i class="uk-icon-caret-down"></i></button>
                           <div class="uk-dropdown">
                               <ul id="devices" class="uk-nav uk-nav-dropdown">
                               </ul>
                           </div>
                       </div>


                     </div>
                     <div class="col-md-6 center-cell">
                        <h2 class="demo-section-title">Realtime Healthcare Dashboard</h2>
                     </div>
                     <div class="col-md-3">
                        <div id=watch align=right class="clock"></div>
                     </div>
                  </div>
                  <!-- END row  TITLE, CLOCK -->
                  <!-- BEGIN row  LOGOs -->
                  <div class="row">
                     <div class="col-md-4">
                        <div>
                           <div class="panel left-cell">
                              <a href="javascript:resetCounters();">
                              <img src="images/logo-oracle.png" alt="" width="260">
                              </a>
                           </div>
                        </div>
                     </div>
                     <div class="col-md-4">
                        <div class="panel-body-small">
                           <h6 id=VERSION>&nbsp;</h6>
                           <div id=ConnectedDeviceInfo style="display:none">
                              <h6 class="text-underline es">Información de dispositivo conectado</h6>
                              <h6 class="text-underline en">Information from connected device</h6>
                              <h6>
                                 <span class="text-underline es">Modelo:&nbsp;<span id=MODEL></span></span>
                                 <span class="text-underline en">Model:&nbsp;<span id=MODEL></span></span>
                              </h6>
                              <h6>
                                 <span class="text-underline es">Nº de Serie:&nbsp;<span id=SERIALNUMBER></span></span>
                                 <span class="text-underline en">Serial Number:&nbsp;<span id=SERIALNUMBER></span></span>
                              </h6>
                           </div>
                        </div>
                     </div>
                     <div class="col-md-4">
                        <div>
                           <div class="panel right-cell">
                              <img src="images/logo-zerintia.png" alt="" width="200">
                           </div>
                        </div>
                     </div>
                  </div>
                  <!-- END row  LOGOs -->
                  <!-- BEGIN row  PATIENT, BATTERY, CNX -->
                  <div class="row">
                     <div class="col-md-8">
                        <div class="panel panel-default">
                           <div class="panel-heading">
                             <h3 class="panel-title es">Paciente registrado</h3>
                             <h3 class="panel-title en">Registered patient</h3>
                           </div>
                           <div class="panel-body">
                              <div class="row">
                                 <div class="col-md-1">
                                    <div class="panel-default center-cell">
                                       <div id=RED style="display:block">
                                          <img src="images/ledred.png" alt="" width="51">
                                       </div>
                                       <div id=GREEN style="display:none">
                                          <img src="images/ledgreen.png" alt="" width="51">
                                       </div>
                                    </div>
                                 </div>
                                 <div class="col-md-10">
                                    <div class="panel-title">
                                      <span id=USUARIO class="patient">n/a</span>
                                    </div>
                                 </div>
                              </div>
                           </div>
                        </div>
                     </div>
                     <div class="col-md-1">
                        <div class="panel panel-default">
                           <div class="panel-heading center-cell">
                             <h3 class="panel-title es">Batería</h3>
                             <h3 class="panel-title en">Battery</h3>
                           </div>
                           <div class="panel-body-light center-cell">
                              <div id="batteryGauge"></div>
                           </div>
                        </div>
                     </div>
                     <div class="col-md-1">
                        <div class="panel panel-default">
                           <div class="panel-heading center-cell">
                              <h3 class="panel-title" id="deviceName">---</h3>
                           </div>
                           <div class="panel-body center-cell">
                              <div id=DISCONNECTED style="display:block">
                                 <img src="images/disconnected.png" width="51">
                              </div>
                              <div id=CONNECTED style="display:none">
                                 <img src="images/connected.png" width="51">
                              </div>
                           </div>
                        </div>
                     </div>
                  </div>
                  <!-- END row  PATIENT, BATTERY, CNX -->
                  <!-- BEGIN row  DATA -->
                  <div class="row">
                     <div class="col-md-2">
                        <div class="panel panel-info">
                           <div class="panel-heading">
                              <a class="panel-title no-link" href="javascript:showUpdatePulseThresholds();">
                                <h3 class="panel-title center-cell es">Pulso (real/media)</h3>
                                <h3 class="panel-title center-cell en">Pulse (real/average)</h3>
                              </a>
                           </div>
                           <div class="panel-body center-cell">
                              <h2 id=PULSO style="color:#364347">000</h2>
                              <h2 id=PULSOAVG>000.00</h2>
                           </div>
                        </div>
                     </div>
                     <div class="col-md-1">
                        <div class="panel panel-info">
                           <div class="panel-heading">
                             <h3 class="panel-title center-cell es">Tensión</h3>
                             <h3 class="panel-title center-cell en">Blood Press</h3>
                           </div>
                           <div class="panel-body center-cell">
                              <h2 id=TENSIONA>000</h2>
                              <h2 id=TENSIONB>000</h2>
                           </div>
                        </div>
                     </div>
                     <div class="col-md-2">
                        <div class="panel panel-info">
                           <div class="panel-heading">
                             <h3 class="panel-title center-cell es">Pasos</h3>
                             <h3 class="panel-title center-cell en">Steps</h3>
                           </div>
                           <div class="panel-body center-cell">
                              <h1>
                                 <span id=PASOS>000</span>
                              </h1>
                           </div>
                        </div>
                     </div>
                     <div class="col-md-2">
                        <div class="panel panel-info">
                           <div class="panel-heading">
                             <h3 class="panel-title center-cell es">Distancia (m)</h3>
                             <h3 class="panel-title center-cell en">Distance (m)</h3>
                           </div>
                           <div class="panel-body center-cell">
                              <h1>
                                 <span id=DISTANCIA>000</span>
                              </h1>
                           </div>
                        </div>
                     </div>
                     <div class="col-md-2">
                        <div class="panel panel-info">
                           <div class="panel-heading">
                             <h3 class="panel-title center-cell es">Peso (Kg)</h3>
                             <h3 class="panel-title center-cell en">Weight (Kg)</h3>
                           </div>
                           <div class="panel-body center-cell">
                              <h1>
                                 <span id=PESO>000</span>
                              </h1>
                           </div>
                        </div>
                     </div>
                  </div>
                  <!-- END row  DATA -->
                  <!-- BEGIN row  NOTIFICATIONS, ALERTS -->
                  <div class="row">
                     <div class="col-md-12">
                        <div class="panel panel-danger">
                           <div class="panel-heading">
                             <h3 class="panel-title es">Alertas</h3>
                             <h3 class="panel-title en">Alerts</h3>
                           </div>
                           <div class="panel-body">
                              <div class="row">
                                 <div class="col-md-0">
                                    <div class="panel-default center-cell">
                                       <div  style="display:none" id=INFO1>
                                          <img src="images/info.png" alt="" width="24">
                                       </div>
                                       <div  style="display:none" id=WARNING1>
                                          <img src="images/warning.png" alt="" width="24">
                                       </div>
                                       <div  style="display:none" id=ERROR1>
                                          <img src="images/error.png" alt="" width="24">
                                       </div>
                                    </div>
                                 </div>
                                 <div class="col-md-11">
                                    <div class="panel-default">
                                       <span id=ALERT1>&nbsp;</span>
                                    </div>
                                 </div>
                              </div>
                              <div class="row">
                                 <div class="col-md-0">
                                    <div class="panel-default center-cell">
                                       <div  style="display:none" id=INFO2>
                                          <img src="images/info.png" alt="" width="24">
                                       </div>
                                       <div  style="display:none" id=WARNING2>
                                          <img src="images/warning.png" alt="" width="24">
                                       </div>
                                       <div  style="display:none" id=ERROR2>
                                          <img src="images/error.png" alt="" width="24">
                                       </div>
                                    </div>
                                 </div>
                                 <div class="col-md-11">
                                    <div class="panel-default">
                                       <span id=ALERT2 style='color:gray'>&nbsp;</span>
                                    </div>
                                 </div>
                              </div>
                              <div class="row">
                                 <div class="col-md-0">
                                    <div class="panel-default center-cell">
                                       <div  style="display:none" id=INFO3>
                                          <img src="images/info.png" alt="" width="24">
                                       </div>
                                       <div  style="display:none" id=WARNING3>
                                          <img src="images/warning.png" alt="" width="24">
                                       </div>
                                       <div  style="display:none" id=ERROR3>
                                          <img src="images/error.png" alt="" width="24">
                                       </div>
                                    </div>
                                 </div>
                                 <div class="col-md-11">
                                    <div class="panel-default">
                                       <span id=ALERT3 style='color:gray'>&nbsp;</span>
                                    </div>
                                 </div>
                              </div>
                              <div class="row">
                                 <div class="col-md-0">
                                    <div class="panel-default center-cell">
                                       <div  style="display:none" id=INFO4>
                                          <img src="images/info.png" alt="" width="24">
                                       </div>
                                       <div  style="display:none" id=WARNING4>
                                          <img src="images/warning.png" alt="" width="24">
                                       </div>
                                       <div  style="display:none" id=ERROR4>
                                          <img src="images/error.png" alt="" width="24">
                                       </div>
                                    </div>
                                 </div>
                                 <div class="col-md-11">
                                    <div class="panel-default">
                                       <span id=ALERT4 style='color:gray'>&nbsp;</span>
                                    </div>
                                 </div>
                              </div>
                              <div class="row">
                                 <div class="col-md-0">
                                    <div class="panel-default center-cell">
                                       <div  style="display:none" id=INFO5>
                                          <img src="images/info.png" alt="" width="24">
                                       </div>
                                       <div  style="display:none" id=WARNING5>
                                          <img src="images/warning.png" alt="" width="24">
                                       </div>
                                       <div  style="display:none" id=ERROR5>
                                          <img src="images/error.png" alt="" width="24">
                                       </div>
                                    </div>
                                 </div>
                                 <div class="col-md-11">
                                    <div class="panel-default">
                                       <span id=ALERT5 style='color:gray'>&nbsp;</span>
                                    </div>
                                 </div>
                              </div>
                              <div class="row">
                                 <div class="col-md-0">
                                    <div class="panel-default center-cell">
                                       <div  style="display:none" id=INFO6>
                                          <img src="images/info.png" alt="" width="24">
                                       </div>
                                       <div  style="display:none" id=WARNING6>
                                          <img src="images/warning.png" alt="" width="24">
                                       </div>
                                       <div  style="display:none" id=ERROR6>
                                          <img src="images/error.png" alt="" width="24">
                                       </div>
                                    </div>
                                 </div>
                                 <div class="col-md-11">
                                    <div class="panel-default">
                                       <span id=ALERT6 style='color:gray'>&nbsp;</span>
                                    </div>
                                 </div>
                              </div>
                              <div class="row">
                                 <div class="col-md-0">
                                    <div class="panel-default center-cell">
                                       <div  style="display:none" id=INFO7>
                                          <img src="images/info.png" alt="" width="24">
                                       </div>
                                       <div  style="display:none" id=WARNING7>
                                          <img src="images/warning.png" alt="" width="24">
                                       </div>
                                       <div  style="display:none" id=ERROR7>
                                          <img src="images/error.png" alt="" width="24">
                                       </div>
                                    </div>
                                 </div>
                                 <div class="col-md-11">
                                    <div class="panel-default">
                                       <span id=ALERT7 style='color:gray'>&nbsp;</span>
                                    </div>
                                 </div>
                              </div>
                              <div class="row">
                                 <div class="col-md-0">
                                    <div class="panel-default center-cell">
                                       <div  style="display:none" id=INFO8>
                                          <img src="images/info.png" alt="" width="24">
                                       </div>
                                       <div  style="display:none" id=WARNING8>
                                          <img src="images/warning.png" alt="" width="24">
                                       </div>
                                       <div  style="display:none" id=ERROR8>
                                          <img src="images/error.png" alt="" width="24">
                                       </div>
                                    </div>
                                 </div>
                                 <div class="col-md-11">
                                    <div class="panel-default">
                                       <span id=ALERT8 style='color:gray'>&nbsp;</span>
                                    </div>
                                 </div>
                              </div>
                              <div class="row">
                                 <div class="col-md-0">
                                    <div class="panel-default center-cell">
                                       <div  style="display:none" id=INFO9>
                                          <img src="images/info.png" alt="" width="24">
                                       </div>
                                       <div  style="display:none" id=WARNING9>
                                          <img src="images/warning.png" alt="" width="24">
                                       </div>
                                       <div  style="display:none" id=ERROR9>
                                          <img src="images/error.png" alt="" width="24">
                                       </div>
                                    </div>
                                 </div>
                                 <div class="col-md-11">
                                    <div class="panel-default">
                                       <span id=ALERT9 style='color:gray'>&nbsp;</span>
                                    </div>
                                 </div>
                              </div>
                              <div class="row">
                                 <div class="col-md-0">
                                    <div class="panel-default">
                                       <div  style="display:none" id=INFO10>
                                          <img src="images/info.png" alt="" width="24">
                                       </div>
                                       <div  style="display:none" id=WARNING10>
                                          <img src="images/warning.png" alt="" width="24">
                                       </div>
                                       <div  style="display:none" id=ERROR10>
                                          <img src="images/error.png" alt="" width="24">
                                       </div>
                                    </div>
                                 </div>
                                 <div class="col-md-11">
                                    <div class="panel-default">
                                       <span id=ALERT10 style='color:gray'>&nbsp;</span>
                                    </div>
                                 </div>
                              </div>
                           </div>
                        </div>
                     </div>
                  </div>
                  <!-- END row  NOTIFICATIONS, ALERTS -->
                  </p>
               </div>
               <div id="debugAccordion" style="display:none">
                  <h3>Debug</h3>
                  <div id=DEBUGPANEL class="row" style="height: 600px;">
                     <div class="col-md-12">
                        <div id="panels">
                           <div id=DEBUG >
                              <p>
                              <form id=ConnectForm name="ConnectForm">
                                 Websocket Server:
                                 <input class="courier-font" id=hostname name="hostname" type="text" size="30" value=''>
                                 <input type="submit" id="connectButton" formaction="javascript:connect(seletcedDevice.imei);" value="Connect">
                                 <input type="submit" id="disconnectButton" disabled=true formaction="javascript:disconnect();" value="Disconnect">
                                 <input type="submit" id="resetButton" formaction="javascript:reset();" value="RESET">
                              </form>
                              </p>
                              <p>
                              <form id=RespondPingForm name="RespondPingForm" class="courier-font">
                                 <input type="checkbox" id="HidePingHandshake" onclick="setHidePing(this);" checked> Hide Ping messages<br>
                              </form>
                              <form name="MessageForm" action="javascript:send();" style="display:none">
                                 Message:
                                 <input class="courier-font" name="message" type="text" size="80" value='REP|ORACLE|PULSESTART|1424550007040|{ "result" : 0, "detail" : "ACK" }'>
                                 <input type="submit" id="SendRequest" disabled=true value="Send request">
                              </form>
                              </p>
                              <br>
                              <form id=ResetOutput name="ResetOutput">
                                 <span class="courier-font"> OUTPUT WINDOW:</span>
                                 <input type="submit" id="clearButton" formaction="javascript:clear();" value="Clear">
                              </form>
                              <p>
                              <div id="output" class="debug-container courier-font"></div>
                              </p>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </div>
      <!-- BEGIN MODAL DIALOGS -->
      <div id="UpdatePulseThresholdsModal" class="uk-modal">
         <div class="uk-modal-dialog">
            <button type="button" class="uk-modal-close uk-close"></button>
            <h3>
              <center class="es">Establecer nuevos umbrales de pulso</center>
              <center class="en">Set new Pulse Thresholds</center>
            </h3>
            <br>
            <div id="GetThresholdsSpinner" style="display:block">
               <div class="uk-modal-spinner"></div>
               <br><br>
            </div>
            <div id="InputThresholdsPanel" class="row" style="display:none">
               <div class="row">
                  <div class="col-sm-2">
                  </div>
                  <div class="col-sm-4">
                    <div class="es">Umbral superior</div>
                    <div class="en">Upper Threshold</div>
                  </div>
                  <div class="col-sm-4">
                    <div class="es">Umbral inferior</div>
                    <div class="en">Lower Threshold</div>
                  </div>
               </div>
               <div class="row">
                  <div class="form-group input-required">
                     <div class="col-sm-2">
                     </div>
                     <div class="col-sm-4">
                       <input id="HighThresholdInput" type="text" class="form-control" required placeholder="">
                        <span></span>
                     </div>
                     <div class="col-sm-4">
                       <input id="LowThresholdInput" type="text" class="form-control" required placeholder="">
                        <span></span>
                     </div>
                  </div>
               </div>
            </div>
            <br>
            <div class="uk-modal-footer uk-text-right">
              <button type="button" class="uk-button" onclick="closeUpdatePulseThresholds();"><div class="es">Cancelar</div><div class="en">Cancel</div></button>
              <button type="button" class="uk-button uk-button-primary" onclick="saveNewThresholds();"><div class="es">Salvar</div><div class="en">Save</div></button>
            </div>
         </div>
      </div>
      <div id="ErrorModalWindow" class="uk-modal">
         <div class="uk-modal-dialog">
            <h3>
               <center id="ErrorModalWindowTitle">dummy</center>
            </h3>
            <br>
            <div id="InputThresholdsPanel" class="row" style="display:block">
               <div class="row">
                 <center id="ErrorModalWindowDetail">dummy</center>
               </div>
               <div class="row">
                 <center id="ErrorModalWindowFooter">dummy</center>
               </div>
            </div>
         </div>
      </div>
      <!-- END MODAL DIALOGS -->
   </body>
   <script language="javascript" type="text/javascript">
      var debug = false;
      var websocket = null;
      var reconnect = true;
      var connected = false;
      var wsserver = "";
      var localwsserver = wsserverURI;
      var wsUri;
      var output;
      var aNotifications   = ['\xA0', '\xA0', '\xA0', '\xA0', '\xA0', '\xA0', '\xA0', '\xA0', '\xA0', '\xA0'];
      var aAlertSeverities = ['\xA0', '\xA0', '\xA0', '\xA0', '\xA0', '\xA0', '\xA0', '\xA0', '\xA0', '\xA0'];
      var aAlerts          = ['\xA0', '\xA0', '\xA0', '\xA0', '\xA0', '\xA0', '\xA0', '\xA0', '\xA0', '\xA0'];
      // Ping stuff
      var hidePing = true;
      var pingTimer = 10000;
      var pingTimeout = 5000;
      var pingSeq = 0;
      var varTimerPing = undefined;
      var varTimerCallback;
      var batteryGauge;
      var deviceList = [];
      var selectedDevice = {};

      const LABELS = {
        ERRORLOADINGDEVICESTITLE: { es: "Error cargando la lista de dispositivos", en: "Error loading the device list" },
        ERRORLOADINGDEVICESDETAIL: { es: "Detalle", en: "Detail" },
        ERRORLOADINGDEVICESFOOTER: { es: "Recargar la página para reintentar", en: "Reload whole page to retry" },
        ERRORCONNECTINGTOSERVER: { es: "Error conectando con el servidor. Refresque el navegador para reintentarlo de nuevo", en: "Error connecting to server. Reload the page to retry" },
        ERRORCONNECTIONLOST: { es: "Perdida la conexión con el servidor. Desconectando sesión", en: "Connection lost with the server. Disconnecting session" },
        NOPATIENT: { es: "(ningún paciente registrado)", en: "(no patient registered yet)" },
        WATCHREMOVED: { es: "El paciente se ha quitado el reloj durante la medición del pulso", en: "The patient has removed the watch during the pulse measurement" },
        GETPULSEDATAERROR: { es: "Error recuperando información de pulso", en: "Error while getting pulse information" },
        GETPULSEDATANODATA: { es: "La petición no ha devuelto datos para el dispositivo", en: "The request hasn't returned data for device" },
        SETPULSEDATAERROR: { es: "Error guardando información de pulso", en: "Error while saving pulse information" },
      }

      window.addEventListener("load", init, false);

      function getParameterByName(name) {
      	name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
      	var regex = new RegExp("[\\?&]" + name + "=([^&#]*)");
      	var results = regex.exec(location.search);
      	return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, '\xA0'));
      }

      function setText(element, message) {
        var e = document.getElementById(element);
        e.removeChild(e.childNodes[0]);
        e.appendChild(document.createTextNode(message));
      }

      function getDeviceList() {
      	$.ajax({
      		type: "GET",
          url: "http://" + serverURI + "/DataServicesMulti/GetDevicesService/getdevices",
      		contentType: "application/json",
      		complete: function (data) {
            if ( data.status !== 200) {
              writeToScreen("Error getting device list: " + data.status , "red");
              setText('ErrorModalWindowTitle', LABELS['ERRORLOADINGDEVICESTITLE'][language]);
              setText('ErrorModalWindowDetail', LABELS['ERRORLOADINGDEVICESDETAIL'][language] + ": " + data.status + " (" + data.statusText + ")");
              setText('ErrorModalWindowFooter', LABELS['ERRORLOADINGDEVICESFOOTER'][language]);
              UIkit.modal("#ErrorModalWindow", {keyboard:false, bgclose:false}).show();
              return;
            }
            deviceList = JSON.parse(data.responseText).Devices;
            var UL = document.getElementById('devices');
            for ( var i = 0; i < deviceList.length; i ++) {
              var item = document.createElement('li');
              var a = document.createElement('a');
              a.appendChild(document.createTextNode(deviceList[i].name));
              var att = document.createAttribute("href");
              att.value = "#";
              a.setAttributeNode(att);
              item.appendChild(a);
              UL.appendChild(item);
            }
      		}
      	});
      }

      function init() {
      	batteryGauge = new JustGage({
      		id: "batteryGauge",
      		value: "?",
      		min: 0,
      		max: 100,
      		label: "%",
      		showTitle: false,
      		showMinMax: false,
      		startAnimationTime: 50,
      		startAnimationType: "bounce",
      		refreshAnimationTime: 100,
      		refreshAnimationType: "bounce",
      		levelColors: [
      		"#FF0000",
      		"#FF9933",
      		"#5CE62E"
      		]
      	});
      	updateClock();
      	$('#VERSION').text(version);
      	output = document.getElementById("output");
      	debug = (getParameterByName('debug') == "true");
      	wsserver = getParameterByName('wsserver');
        language = getParameterByName('language') || 'en';
        enableLanguage(language);
      	if ( wsserver == "")
      		wsserver = localwsserver;
      	document.getElementById("ConnectForm").elements["hostname"].value = wsserver;

        // First, let's get the device list
        getDeviceList();

      	if ( debug) {
      		console.log("init()");
      		$('#debugAccordion').css('display', 'block');
      	}
      }

      function connect(imei) {
      	var msg;
      	hostname = document.getElementById('hostname').value;

      	wsUri = "ws://" + hostname + "/websocketsmulti/event?id=DASHBOARD," + imei;
      	writeToScreen("Connecting to " + wsUri);
      	websocket = new WebSocket(wsUri);
      	websocket.onopen = function(evt) {
      		onOpen(evt)
      	};
      	websocket.onclose = function(evt) {
      		onClose(evt)
      	};
      	websocket.onmessage = function(evt) {
      		onMessage(evt)
      	};
      	websocket.onerror = function(evt) {
      		onError(evt)
      	};
      }

      function disconnect() {
      	if ( varTimerPing != undefined) {
      		clearInterval(varTimerPing);
      		varTimerPing = undefined;
      	}
      	if ( websocket != null) {
      		console.log("disconnect()");
      		writeToScreen("Disconnecting from " + wsUri);
      		reconnect = false;
      		websocket.close();
      		websocket = null;
      	}
      }

      function onOpen(evt) {
      	console.log("onOpen()");
      	writeToScreen("Successfully connected to " + wsUri, "green");
      	$('#DISCONNECTED').css('display', 'none');
      	$('#CONNECTED').css('display', 'block');
      	document.getElementById('connectButton').disabled = true;
      	document.getElementById('disconnectButton').disabled = false;
      	document.getElementById('SendRequest').disabled = false;
      	reconnect = true;
        connected = true;
      }

      function onClose(evt) {
      	console.log("onClose()");
      	console.log('Reason: ' + evt.reason);
      	writeToScreen("Disconnected from " + wsUri, "red");
        connected = false;
      	if ( evt.reason != '') {
      		writeToScreen('Reason: ' + evt.reason+'</span>');
      	}
      	if ( varTimerPing != undefined) {
      		clearInterval(varTimerPing);
      		varTimerPing = undefined;
      		writeToScreen("Ping server timer successfully stopped", "green");
      	}
      	$('#DISCONNECTED').css('display', 'block');
      	$('#CONNECTED').css('display', 'none');
      	if ( !reconnect) {
      		resetData();
      		document.getElementById('connectButton').disabled = false;
      		document.getElementById('disconnectButton').disabled = true;
      		document.getElementById('SendRequest').disabled = true;
      	}
      	if ( reconnect) {
      		console.log("Unexpected disconnection. Trying to reconnect...");
      		connect(selectedDevice.imei);
      	}
      }

      function onMessage(evt) {
        // Get the first header
        var message = evt.data;
        var header = message.split("|")[0];

      	if ( !( ( evt.data.indexOf("PING") > -1) && hidePing)) {
      		writeToScreen("Incoming message: " + evt.data, "blue");
      	}
      	if ( header === "ACK") {
      		pingSeq = 0;
      		writeToScreen("Enabled ping server timer every " + pingTimer + " milliseconds with a timeout of " + pingTimeout + " milliseconds" , "green");
      		varTimerPing = setInterval(pingServer, pingTimer);
      		// Call REST API REGISTER to refresh patient connected data, if any
      		writeToScreen("About to call registerRequest()" , "green");
      		registerRequest();
          return;
      	}
        if ( header === "ERR") {
      		var message = evt.data;
      		var messageElements = message.split("|");
      		writeToScreen("Error connecting with server: " +  messageElements[2], "red");
      		reconnect = false;
      		console.log("Error conectando con el servidor. Refresque el navegador para reintentarlo de nuevo");
      		insertAlert("ERROR", LABELS['ERRORCONNECTINGTOSERVER'][language]);
      	} else {
      		handleMessage(evt.data);
      		document.getElementById('SendRequest').disabled = false;
      	}
      }

      function onError(evt) {
      	console.log("onError()");
      	console.log("ERROR: " + evt.data);
      	reconnect = false;
      	writeToScreen("ERROR: " + evt.data, "red");
      }

      function doSend(message) {
      	if ( !( ( message.indexOf("PING") > -1) && hidePing))
      	writeToScreen("SENT: " + message);
      	websocket.send(message);
      }

      function registerRequest() {
/**
        writeToScreen("registerRequest()" , "green");
        writeToScreen("URI: "  + "http://" + serverURI + "/WearableDemoMulti/Proxy/register", "green");
        writeToScreen("Data: " + JSON.stringify({ deviceId : selectedDevice.imei }), "green");
**/
      	$.ajax({
      		type: "POST",
          url: "http://" + serverURI + "/WearableDemoMulti/Proxy/register",
      		data: JSON.stringify({ deviceId : selectedDevice.imei }),
      		contentType: "application/json",
      		complete: function (data) {
/**
      			writeToScreen("registerRequest onData()" , "green");
      			writeToScreen("Data: " + JSON.stringify(data), "blue");
**/
      		}
      	});
      }

      function writeToScreen(message, color) {
      	var m = message;
      	if ( color != null) {
      		m = '<span style="color: ' + color + ';">' + message + '</span>';
      	}
      	var pre = document.createElement("p");
      	pre.style.display = "inline";
      	msg = getNow() + '\xA0' + m;
      	pre.innerHTML = msg;
      	output.appendChild(pre);
      	output.appendChild(document.createElement("br"));
      	scrollToEnd();
      }

      function scrollToEnd() {
      	var elem = document.getElementById('output');
      	elem.scrollTop = elem.scrollHeight;
      }

      function send() {
      	message = document.forms["MessageForm"]["message"].value;
      	doSend(message);
      }

      function getNow() {
      	var date = new Date();
      	var hours = "0" + date.getHours();
      	var minutes = "0" + date.getMinutes();
      	var seconds = "0" + date.getSeconds();
      	var milliseconds = "00" + date.getMilliseconds();
      	var formattedTime = '[' + hours.substr(hours.length-2) + ':' + minutes.substr(minutes.length-2) + ':' + seconds.substr(seconds.length-2) + ':' + milliseconds.substr(milliseconds.length-3)  + ']';
      	return formattedTime;
      }

      function reset() {
      	clear();
      	disconnect();
      	resetData();
      	connect(selectedDevice.imei);
      }

      function pingServer() {
      	// REQ|ORACLE|PING|1429868652218|{"seq":1}
      	var pingMessage = "REQ|ORACLE|PING|" + new Date().getTime() + "|{\"seq\":" + (++pingSeq) + "}";
      	doSend(pingMessage);
      	varTimerCallback = setTimeout(function() {
      		console.log("PING NOT RECEIVED IN TIME");
      		writeToScreen("PING TO SERVER LOST (Seq: " + pingSeq + ")", "red");
      		insertAlert("ERROR", LABELS['ERRORCONNECTIONLOST'][language]);
      		disconnect();
      	}, pingTimeout);
      }

      function resetCounters() {
      	$('#PULSO').text("000");
      	$('#PULSOAVG').text("000.00");
      	$('#PULSOAVG').attr('style','color:#364347');
      	$('#TENSIONA').text("000");
      	$('#TENSIONB').text("000");
      	$('#PASOS').text("000");
      	$('#DISTANCIA').text("000");
      	$('#PESO').text("000");
      	//						aNotifications   = ['\xA0', '\xA0', '\xA0', '\xA0', '\xA0', '\xA0', '\xA0', '\xA0', '\xA0', '\xA0'];
      	//						for ( i = 0; i <= 9; i++)
      	//							$('#NOTIFICATION' + (i + 1)).text(aNotifications[i]);
      	aAlertSeverities = ['\xA0', '\xA0', '\xA0', '\xA0', '\xA0', '\xA0', '\xA0', '\xA0', '\xA0', '\xA0'];
      	aAlerts          = ['\xA0', '\xA0', '\xA0', '\xA0', '\xA0', '\xA0', '\xA0', '\xA0', '\xA0', '\xA0'];
      	for ( i = 0; i <= 9; i++) {
      		$('#ALERT' + (i + 1)).text(aAlerts[i]);
      		$('#INFO' + (i + 1)).css('display', 'none');
      		$('#WARNING' + (i + 1)).css('display', 'none');
      		$('#ERROR' + (i + 1)).css('display', 'none');
      	}
      }

      function resetData() {
      	user = LABELS['NOPATIENT'][language];
      	$('#ConnectedDeviceInfo').css('display','none');
      	$('#GREEN').css('display', 'none');
      	$('#RED').css('display', 'block');
      	$('#USUARIO').text(user);
      	updateBattery(-1);
      	resetCounters();
      }

      function clear() {
      	$("#output").html("");
      }

      function setHidePing(cb) {
      	hidePing = cb.checked;
      }

      function insertNotification(text) {
      	insertAlert("INFO", text);
      }

      function insertAlert(severity, text) {
      	for ( i = 9; i >= 1; i--) {
      		aAlerts[i] = aAlerts[i-1];
      		aAlertSeverities[i] = aAlertSeverities[i-1];
      	}
      	aAlerts[0] = text;
      	aAlertSeverities[0] = severity;
      	for ( i = 0; i <= 9; i++) {
      		$('#ALERT' + (i + 1)).text(aAlerts[i]);
      		switch (aAlertSeverities[i]) {
      			case "INFO":
      			$('#INFO' + (i + 1)).css('display', 'block');
      			$('#WARNING' + (i + 1)).css('display', 'none');
      			$('#ERROR' + (i + 1)).css('display', 'none');
      			break;
      			case "WARNING":
      			$('#INFO' + (i + 1)).css('display', 'none');
      			$('#WARNING' + (i + 1)).css('display', 'block');
      			$('#ERROR' + (i + 1)).css('display', 'none');
      			break;
      			case "ERROR":
      			$('#INFO' + (i + 1)).css('display', 'none');
      			$('#WARNING' + (i + 1)).css('display', 'none');
      			$('#ERROR' + (i + 1)).css('display', 'block');
      			break;
      			default:
      			break;
      		}
      	}
      }

      function updateBattery(currentVal)
      {
      	if ( currentVal == -1) {
      		batteryGauge.refresh("?");
      	} else {
      		batteryGauge.refresh(Math.round(currentVal * 100) / 100);
      	}
      }

    	function updateClock() {
    		var now = new Date();

    		// Get the hours, minutes and seconds from the current time
    		var hours = now.getHours();
    		var minutes = now.getMinutes();
    		var seconds = now.getSeconds();

    		// Format hours, minutes and seconds
    		if (hours < 10) {
    			hours = "0" + hours;
    		}
    		if (minutes < 10) {
    			minutes = "0" + minutes;
    		}
    		if (seconds < 10) {
    			seconds = "0" + seconds;
    		}
    		$("#watch").text(hours + ':' + minutes + ':' + seconds);
    	}

    	function EnablePulseThresholds(){
    		if ( getPulseThresholds()) {
      		$('#THRESHOLDSRESPONSE').text("");
      		$("#Submit").prop('value', 'Salvar');
      		$('#PULSETHRESHOLDSPANE').css('display', 'inline-block');
        }
    	};

    	function handleMessage(message) {

        console.log(message);

    		var messageElements = message.split("|");
    		var messageType = messageElements[0];
    		var target = messageElements[1];
    		if ( target != "DASHBOARD," + selectedDevice.imei) {
          writeToScreen("Error: incoming message with invalid target: " + message, "red");
    			return;
    		}
    		var op = messageElements[2];
    		var corrId = messageElements[3];
    		var jsonString = messageElements[4];
    		var jsonObject = JSON.parse(jsonString);

    		if ( messageType == "NOT") {
    			var response = "";
    			if ( op == "REGISTEREVENT") {
    				// NOT|DASHBOARD|REGISTEREVENT|<corrId>|{ "user" : "CCASARES", "status" : "registered" }
    				if ( jsonObject.status == "registered") {
    					user = jsonObject.user;
    					$('#RED').css('display', 'none');
    					$('#GREEN').css('display', 'block');

    				} else if ( jsonObject.status == "unregistered") {
    					user = "n/a";
    					$('#GREEN').css('display', 'none');
    					$('#RED').css('display', 'block');
    					$('#ConnectedDeviceInfo').css('display','none');
    					updateBattery(-1);
    				} else {
    					// TODO: handle unknown data
    				}
            console.log("About to update label with: " + user);
    				$('#USUARIO').text(user);
    			} else
    				if ( op == "DEVICEINFOEVENT") {
    					// NOT|DASHBOARD|DEVICEINFOEVENT|<corrId>|{"model" : "Samsung Gear S","serial" : "AF4426246772-88376","battery" : 100}
    					$('#MODEL').text(jsonObject.model);
    					$('#SERIALNUMBER').text(jsonObject.serial);
    					$('#ConnectedDeviceInfo').css('display','block');
    					updateBattery(jsonObject.battery);
    				} else //
    					if ( op == "PULSEEVENT") {
    						// NOT|DASHBOARD|PULSEEVENT|<corrId>|{ "value" : 123 }
    						$('#PULSO').text(jsonObject.value);
    					} else
    						if ( op == "PULSEAVGEVENT") {
    							// NOT|DASHBOARD|PULSEAVGEVENT|<corrId>|{ "value" : 123, "type" : "OK|WARN" }
    							var type = jsonObject.type;
    							var color = (jsonObject.type == "OK") ? "color:#364347" : "color:#cc0000";
    							if ( jsonObject.type == "WATCH_REMOVED") {
    								insertAlert("ERROR", LABELS['WATCHREMOVED'][language]);
    							} else {
    								$('#PULSOAVG').attr('style',color);
    								$('#PULSOAVG').text((jsonObject.value).toFixed(2));
    							}
    						} else
    							if ( op == "STEPEVENT") {
    								// NOT|DASHBOARD|STEPEVENT|<corrId>|{ "value" : 123 }
    								$('#PASOS').text(jsonObject.value);
    							} else
    								if ( op == "BLOODPRESSUREEVENT") {
    									// NOT|DASHBOARD|BLOODPRESUREEVENT|<corrId>|{ "high" : 123, "low" : 456 }
    									$('#TENSIONA').text(jsonObject.high);
    									$('#TENSIONB').text(jsonObject.low);
    								} else
    									if ( op == "DISTANCEEVENT") {
    										// NOT|DASHBOARD|DISTANCEEVENT|<corrId>|{ "value" : 123 }
    										$('#DISTANCIA').text(jsonObject.value);
    									} else
    										if ( op == "WEIGHTEVENT") {
    											// NOT|DASHBOARD|WEIGHTEVENT|<corrId>|{ "value" : 123 }
    											$('#PESO').text(jsonObject.value);
    										} else
    											if ( op == "BATTERYEVENT") {
    												// NOT|DASHBOARD|BATTERYEVENT|<corrId>|{ "value" : 123 }
    												updateBattery(jsonObject.value);
    											} else
    												if ( op == "NOTIFICATIONEVENT") {
    													// NOT|DASHBOARD|NOTIFICATIONEVENT|<corrId>|{ "es|en" : "my notification text" }
    														insertNotification(jsonObject[language]);
    												} else
    													if ( op == "ALERTEVENT") {
    														// NOT|DASHBOARD|ALERTEVENT|<corrId>|{ "severity" : "INFO", "es|en" : "my info alert text" }
    														// NOT|DASHBOARD|ALERTEVENT|<corrId>|{ "severity" : "WARNING", "es|en" : "my warning alert text" }
    														// NOT|DASHBOARD|ALERTEVENT|<corrId>|{ "severity" : "ERROR", "es|en" : "my error alert text" }
    														insertAlert(jsonObject.severity, jsonObject[language]);
    													} else {
    														console.log("[" + messageType + "] Invalid op code: " + op);
    													}
    													response = "REP|ORACLE|" + op + "|" + corrId + "|" + "{ \"result\" : 0, \"detail\" : \"Notification processed successfully\" }";
    													doSend(response);
    												} else
															if ( messageType == "REP") {
	    													if ( op == "PING") {
	    														// REP|SamsungGearS|PING|1429868652218|{"seq":1}
	    														if ( pingSeq != jsonObject.seq)
	    														writeToScreen("WARNING: Ping sequence mistmatch received. Expected: " + pingSeq + ", received: " +  jsonObject.seq, "red");
	    														clearTimeout(varTimerCallback);
	    													} else
  																console.log("[" + messageType + "] Invalid op code: " + op);
    														}
					}


   </script>
   <!-- Bootstrap core JavaScript
      ================================================== -->
   <!-- Placed at the end of the document so the pages load faster -->
   <script src="js/jquery-1.11.0.min.js"></script>
   <script src="bootstrap/js/bootstrap.min.js"></script>
   <script src="js/bootstrap-switch.js"></script>
   <script src="js/toolbar.js"></script>
   <script src="js/application.js"></script>
   <script src="js/raphael.2.1.0.min.js"></script>
   <script src="js/justgage.1.0.1.js"></script>
   <script src="uikit/js/uikit.min.js"></script>
   <script language="javascript" type="text/javascript">
      function showUpdatePulseThresholds() {
        if ( selectedDevice.imei === "" || selectedDevice.imei === undefined)
          return;
      	UIkit.modal("#UpdatePulseThresholdsModal").show();
      }

      function closeUpdatePulseThresholds() {
      	UIkit.modal("#UpdatePulseThresholdsModal").hide();
      }

      function getPulseThresholds() {
        $.ajax({
      		type: "GET",
          url: "http://" + serverURI + "/DataServicesMulti/GetPulseThresholdService/getpulsethreshold/" + selectedDevice.imei,
      		contentType: "application/json",
      		complete: function (data) {
            if ( data.status !== 200) {
              setText('ErrorModalWindowTitle', LABELS['GETPULSEDATAERROR'][language]);
              setText('ErrorModalWindowDetail', "Info: " + data.status + " (" + data.statusText + ")");
              setText('ErrorModalWindowFooter', '');
              UIkit.modal("#ErrorModalWindow", {keyboard:true, bgclose:true}).show();
              return false;
            }
            if ( data.responseJSON === null) {
              setText('ErrorModalWindowTitle', LABELS['GETPULSEDATAERROR'][language]);
              setText('ErrorModalWindowDetail', LABELS['GETPULSEDATANODATA'][language] + " " + selectedDevice.imei);
              setText('ErrorModalWindowFooter', '');
              UIkit.modal("#ErrorModalWindow", {keyboard:true, bgclose:true}).show();
              return false;
            } else {
              var thresholds = data.responseJSON.PulseThresholds[0];
              $('#HighThresholdInput').attr("placeholder", thresholds.high);
              $('#LowThresholdInput').attr("placeholder", thresholds.low);
              setTimeout(function() {
                $('#GetThresholdsSpinner').css('display', 'none');
                $('#InputThresholdsPanel').css('display', 'block');
              },500);
              return true;
            }
      		}
      	});
      }

      function saveNewThresholds() {
      	var low  = "";
      	var high = "";
      	low = $('#LowThresholdInput').val();
      	high = $('#HighThresholdInput').val();
      	if ( low == "") {
      		low = $('#LowThresholdInput').attr("placeholder");
      	}
      	if ( high == "") {
      		high = $('#HighThresholdInput').attr("placeholder");
      	}
      	$('#GetThresholdsSpinner').css('display', 'block');
      	$('#InputThresholdsPanel').css('display', 'none');

        var payload = {
          "PulseThresholds": [ {
          "id": selectedDevice.imei,
          "low": low,
          "high": high
          } ]
        };

        $.ajax({
      		type: "PUT",
          url: "http://" + serverURI + "/DataServicesMulti/SetPulseThresholdService/setpulsethreshold",
      		data: JSON.stringify(payload),
      		contentType: "application/json",
      		complete: function (data) {
            closeUpdatePulseThresholds();
            if ( data.status !== 202) {
              setText('ErrorModalWindowTitle', LABELS['SETPULSEDATAERROR'][language]);
              setText('ErrorModalWindowDetail', "Info: " + data.status + " (" + data.statusText + ")");
              setText('ErrorModalWindowFooter', '');
              UIkit.modal("#ErrorModalWindow", {keyboard:true, bgclose:true}).show();
              return;
            }
      		}
      	});
      }

      $('#UpdatePulseThresholdsModal').on({
      	'show.uk.modal': function() {
      		$('#HighThresholdInput').val("");
      		$('#LowThresholdInput').val("");
      		getPulseThresholds();
      	},
      	'hide.uk.modal': function() {
      		$('#GetThresholdsSpinner').css('display', 'block');
      		$('#InputThresholdsPanel').css('display', 'none');
      	}
      });

   </script>

   <script language="javascript" type="text/javascript">
     function getEventTarget(e) {
         e = e || window.event;
         return e.target || e.srcElement;
     }

     var ul = document.getElementById('devices');
     ul.onclick = function(event) {
         selectedDevice = {};
         var target = getEventTarget(event);
         selectedDevice.name = target.innerHTML;
         var d = $.grep(deviceList, function(e){ return e.name == selectedDevice.name; });
         if (d.length == 0) {
           // Not found?????
           console.log("device " + selectedDevice.name + ", not found in deviceList array: " + JSON.stringify(deviceList));
           return;
         }
         selectedDevice.imei = d[0].imei;
         var but = document.getElementById("selectDevice");
         but.innerHTML = selectedDevice.name + "&nbsp;&nbsp;&nbsp;<i class='uk-icon-caret-down'></i>";
         var h = document.getElementById("deviceName");
         h.removeChild(h.childNodes[0]);
         h.appendChild(document.createTextNode(selectedDevice.name));
         if (connected)
           disconnect();
         connect(selectedDevice.imei);
     };
   </script>

   </body>
</html>
